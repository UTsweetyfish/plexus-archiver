{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"30134","self":"http://jira.codehaus.org/rest/api/latest/issue/30134","key":"PLXCOMP-8","fields":{"progress":{"progress":0,"total":0},"summary":"zip archiver cannot update zip files","timetracking":{},"issuetype":{"self":"http://jira.codehaus.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://jira.codehaus.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"customfield_10110":null,"votes":{"self":"http://jira.codehaus.org/rest/api/2/issue/PLXCOMP-8/votes","votes":3,"hasVoted":false},"resolution":null,"fixVersions":[],"resolutiondate":null,"customfield_10210":"4.0","timespent":null,"reporter":{"self":"http://jira.codehaus.org/rest/api/2/user?username=jerico","name":"jerico","emailAddress":"jerico@yandex.ru","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Sergey Ponomarev","active":true},"aggregatetimeoriginalestimate":null,"customfield_10161":["ffray(ffray)","mszalinski(mszalinski)","rfscholte(rfscholte)","jerico(jerico)"],"customfield_10160":null,"updated":"2011-03-26T04:46:49.643-0500","created":"2005-11-25T03:17:48.464-0600","description":"While trying to add existing file to existing jar file (update mode), archiver throws error:\r\n\r\n{noformat}Caused by: org.codehaus.plexus.archiver.ArchiverException: Problem creating jar: Negative seek offset (and the archive is probably corrupt but I could not delete it) (and I couldn't rename the temporary file ip1185187450.tmp back)\r\n        at org.codehaus.plexus.archiver.zip.AbstractZipArchiver.createArchiveMain(AbstractZipArchiver.java:403)\r\n        at org.codehaus.plexus.archiver.zip.AbstractZipArchiver.createArchive(AbstractZipArchiver.java:229)\r\n        at com.db.gcf.gbcrm.maven2.plugins.Utils.pack(Utils.java:150)\r\n        ... 21 more\r\nCaused by: java.io.IOException: Negative seek offset\r\n        at java.io.RandomAccessFile.seek(Native Method)\r\n        at org.codehaus.plexus.archiver.zip.ZipFile.positionAtCentralDirectory(ZipFile.java:383)\r\n        at org.codehaus.plexus.archiver.zip.ZipFile.populateFromCentralDirectory(ZipFile.java:254)\r\n        at org.codehaus.plexus.archiver.zip.ZipFile.<init>(ZipFile.java:148)\r\n        at org.codehaus.plexus.archiver.zip.ZipFile.<init>(ZipFile.java:105)\r\n        at org.codehaus.plexus.archiver.zip.AbstractZipArchiver.getResourcesToAdd(AbstractZipArchiver.java:419)\r\n        at org.codehaus.plexus.archiver.zip.AbstractZipArchiver.createArchiveMain(AbstractZipArchiver.java:330)\r\n        ... 23 more{noformat}\r\n\r\nMethod I used:\r\n{code:java}/**\r\n     * Adds file or directory to given archive\r\n     * @param archiverManager that manages archivers\r\n     * @param aFile file or directory to pack\r\n     * @param aArchive archive to create or update\r\n     * @param update identifies if archive always created or existing archive is\r\n     * created\r\n     * @throws MojoExecutionException if any errors with file reading or writing\r\n     * occured\r\n     * @throws NoSuchArchiverException if archive extention does not have\r\n     * corresponding archiver\r\n     */\r\n    public static void pack(ArchiverManager archiverManager, File aFile,\r\n            String aDestFileName, File aArchive, boolean update)\r\n            throws NoSuchArchiverException, MojoExecutionException {\r\n        String archiveExt = FileUtils.getExtension(aArchive.getAbsolutePath())\r\n                .toLowerCase();\r\n        try {\r\n            Archiver archiver = archiverManager.getArchiver(archiveExt);\r\n            if (archiver instanceof ZipArchiver) {\r\n                ((ZipArchiver)archiver).setUpdateMode(update);\r\n            }\r\n            archiver.setDestFile(aArchive);\r\n            archiver.addFile(aFile, aDestFileName);\r\n            archiver.createArchive();\r\n        } catch (ArchiverException e) {\r\n            throw new MojoExecutionException(\"Error occured while packing file[\"\r\n                    + aFile + \"] to archive[\" + aArchive + \"]\", e);\r\n        } catch (IOException e) {\r\n            throw new MojoExecutionException(\"Error occured while packing file[\"\r\n                    + aFile + \"] to archive[\" + aArchive + \"]\", e);\r\n        }\r\n    }{code}","priority":{"self":"http://jira.codehaus.org/rest/api/2/priority/3","iconUrl":"http://jira.codehaus.org/images/icons/priorities/major.png","name":"Major","id":"3"},"duedate":null,"issuelinks":[],"customfield_10163":"121737600","watches":{"self":"http://jira.codehaus.org/rest/api/2/issue/PLXCOMP-8/watchers","watchCount":6,"isWatching":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"subtasks":[],"status":{"self":"http://jira.codehaus.org/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"http://jira.codehaus.org/images/icons/statuses/open.png","name":"Open","id":"1"},"customfield_10090":null,"labels":[],"workratio":-1,"assignee":null,"attachment":[{"self":"http://jira.codehaus.org/rest/api/2/attachment/54059","id":"54059","filename":"fix_update.patch","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-04T10:29:49.228-0600","size":4119,"mimeType":"text/plain","content":"http://jira.codehaus.org/secure/attachment/54059/fix_update.patch"},{"self":"http://jira.codehaus.org/rest/api/2/attachment/54051","id":"54051","filename":"fix_update.patch","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-04T06:01:29.755-0600","size":2766,"mimeType":"text/plain","content":"http://jira.codehaus.org/secure/attachment/54051/fix_update.patch"},{"self":"http://jira.codehaus.org/rest/api/2/attachment/54122","id":"54122","filename":"PLXCOMP-8.patch","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-08T08:39:49.720-0600","size":2999,"mimeType":"text/plain","content":"http://jira.codehaus.org/secure/attachment/54122/PLXCOMP-8.patch"},{"self":"http://jira.codehaus.org/rest/api/2/attachment/37257","id":"37257","filename":"Verify-PLXCOMP-8.patch","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=ffray","name":"ffray","emailAddress":"fray@itcf.biz","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Florian Fray","active":true},"created":"2008-09-29T07:54:23.087-0500","size":3154,"mimeType":"text/plain","content":"http://jira.codehaus.org/secure/attachment/37257/Verify-PLXCOMP-8.patch"}],"customfield_10221":null,"customfield_10220":null,"customfield_10200":null,"aggregatetimeestimate":null,"customfield_10190":null,"project":{"self":"http://jira.codehaus.org/rest/api/2/project/11440","id":"11440","key":"PLXCOMP","name":"Plexus Components","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/projectavatar?size=xsmall&pid=11440&avatarId=10011","24x24":"http://jira.codehaus.org/secure/projectavatar?size=small&pid=11440&avatarId=10011","32x32":"http://jira.codehaus.org/secure/projectavatar?size=medium&pid=11440&avatarId=10011","48x48":"http://jira.codehaus.org/secure/projectavatar?pid=11440&avatarId=10011"},"projectCategory":{"self":"http://jira.codehaus.org/rest/api/2/projectCategory/10003","id":"10003","description":"various containers","name":"containers"}},"versions":[],"customfield_10170":null,"environment":"WinXP version 2002 SP1, jdk1.5.0b64, maven2 ","timeestimate":null,"customfield_10130":null,"aggregateprogress":{"progress":0,"total":0},"lastViewed":null,"components":[{"self":"http://jira.codehaus.org/rest/api/2/component/12540","id":"12540","name":"plexus-archiver"}],"comment":{"startAt":0,"maxResults":6,"total":6,"comments":[{"self":"http://jira.codehaus.org/rest/api/2/issue/30134/comment/149270","id":"149270","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=ffray","name":"ffray","emailAddress":"fray@itcf.biz","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Florian Fray","active":true},"body":"Could not reproduce this issue.\r\n\r\nI've attached a patch to the JarArchiverTest and copied some of your code in.\r\nMaybe you could re-run your code or patch the Unit-Test and modify it in a way to proove this issue against the current version of plexus-archiver.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=ffray","name":"ffray","emailAddress":"fray@itcf.biz","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Florian Fray","active":true},"created":"2008-09-29T07:54:23.096-0500","updated":"2008-09-29T07:54:23.096-0500"},{"self":"http://jira.codehaus.org/rest/api/2/issue/30134/comment/158218","id":"158218","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=mszalinski","name":"mszalinski","emailAddress":"mszalinski@gmail.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Michal Szalinski","active":true},"body":"I had similar issue when using version alpha-7\r\nafter update to alpha-10 this one is gone\r\nHOWEVER:\r\nit seems that updating an archive doesnt work at all!\r\nto check it change the test case so update flag is true.\r\nAfter adding first file archive with it is created,\r\nwhen adding another file whole archive is replaced with new one containing only new file.\r\n\r\nI checked the AbstractZipArchiver code and in createArchive method steps are as follows (in update mode):\r\n1. create copy of archive\r\n2. put all resources to original archive (it always overrides archive)\r\n3. delete tmp file (which is not needed as renamedFile.deleteOnExit() is used just after file creation)\r\n\r\nno merging of tmp and new archive is made.\r\n\r\nAm i doing something wrong?","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=mszalinski","name":"mszalinski","emailAddress":"mszalinski@gmail.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&avatarId=10232","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&avatarId=10232","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&avatarId=10232","48x48":"http://jira.codehaus.org/secure/useravatar?avatarId=10232"},"displayName":"Michal Szalinski","active":true},"created":"2008-12-16T15:45:25.413-0600","updated":"2008-12-16T15:45:25.413-0600"},{"self":"http://jira.codehaus.org/rest/api/2/issue/30134/comment/258518","id":"258518","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"body":"I ran into this problem too, just discovered it's already a pretty old issue.\r\nI've attached a new testcase and the required fix.\r\nMaybe it was caused by the assumption the following code would keep the existing ZipEntries:\r\n{code}\r\nzOut = new ZipOutputStream( zipFile );\r\n{code}","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-04T05:51:37.859-0600","updated":"2011-03-04T05:51:37.859-0600"},{"self":"http://jira.codehaus.org/rest/api/2/issue/30134/comment/258520","id":"258520","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"body":"A small improvement: closing the temp-zipfile so it can be removed","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-04T06:01:29.770-0600","updated":"2011-03-04T06:01:29.770-0600"},{"self":"http://jira.codehaus.org/rest/api/2/issue/30134/comment/258550","id":"258550","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"body":"Previous patch only created empty entries. This one should copy the content as well. I had to fix the {{PlexusIoZipFileResourceCollection}} too, since it didn't close the {{ZipFile}}, which made it impossible to delete the temp-file.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-04T10:29:49.243-0600","updated":"2011-03-04T10:29:49.243-0600"},{"self":"http://jira.codehaus.org/rest/api/2/issue/30134/comment/259336","id":"259336","author":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"body":"Part of my issue was caused by an other bug, this should be the final patch.\r\nThere's one minor issue I couldn't solve:\r\nThe temporary created file can't be deleted because the {{ZipFile}} can't be closed. A {{ZipEntry}} holds a reference to the original {{ZipFile}}, so closing it too early would break the {{ZipEntry}}. The result is a warning-message that the file couldn't be deleted. Once the jvm has finished, the file is released and can be removed.","updateAuthor":{"self":"http://jira.codehaus.org/rest/api/2/user?username=rfscholte","name":"rfscholte","emailAddress":"codehaus@sourcegrounds.com","avatarUrls":{"16x16":"http://jira.codehaus.org/secure/useravatar?size=xsmall&ownerId=rfscholte&avatarId=10919","24x24":"http://jira.codehaus.org/secure/useravatar?size=small&ownerId=rfscholte&avatarId=10919","32x32":"http://jira.codehaus.org/secure/useravatar?size=medium&ownerId=rfscholte&avatarId=10919","48x48":"http://jira.codehaus.org/secure/useravatar?ownerId=rfscholte&avatarId=10919"},"displayName":"Robert Scholte","active":true},"created":"2011-03-08T08:39:49.743-0600","updated":"2011-03-08T08:39:49.743-0600"}]},"timeoriginalestimate":null,"aggregatetimespent":null}}